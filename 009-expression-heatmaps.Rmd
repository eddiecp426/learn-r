---
title: "Heatmaps - the gene expression edition"
author: "Jeff Oliver"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document:
    latex_engine: xelatex
---

An application of heatmap visualization to investigate differential gene expression.

#### Learning objectives
1. Manipulate data into a 'tidy' format
2. Visualize data in a heatmap
3. Become familiar with `ggplot` syntax for customizing plots

## Heatmaps for differential gene expression
Heatmaps are a great way of displaying three-dimensional data in only two dimensions. But how can we easily translate tabular data into a format for heatmap plotting? By taking advantage of "data munging" and graphics packages, heatmaps are relatively easy to produce in R. 

***

## Getting started
We are going to start by isolating different types of information by imposing structure in our file managment. That is, we are going to put our input data in one folder and any output such as plots or analytical results in a different folder. We can use the `dir.create` to create these two folders:
```{r eval = FALSE}
dir.create("data")
dir.create("output")
```

For this lesson, we will use a subset of data on a study of gene expression in cells infected with the influenza virus ([doi: 10.4049/jimmunol.1501557](https://doi.org/10.4049/jimmunol.1501557)). The study infected human plasmacytoid dendritic cells with the influenza virus, and compared gene expression in those cells to gene expression in uninfected cells. The goal was to see how the flu virus affected the function of these immune system cells.  
The data for this lesson is available at: [http://tinyurl.com/flu-expression-data](http://tinyurl.com/flu-expression-data) or [https://jcoliver.github.io/learn-r/data/GSE68849-expression.csv](https://jcoliver.github.io/learn-r/data/GSE68849-expression.csv). Download this comma separated file and put it in the `data` folder. 

Finally, we will be using two packages that are not distributed with the base R software, so we need to install them. Note that you only have to install packages once on your machine.
```{r eval = FALSE}
install.packages("ggplot2")
install.packages("tidyr")
```

***

## Data Wrangling
We'll need to start by reading the data into memory then formatting it for use by the ggplot package. We want all our work to be reproducible, so create a script where we can store all the commands we use to create the heatmap. We begin this script with brief information about the purpose of the script and load those two packages so we can use them:

```{r}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")
```

And then we read the data into memory:
```{r}
exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)
```

Take a quick look at the data with the `str` command:
```{r}
str(exp.data)
```

The data frame has `r nrow(exp.data)` rows (or subjects) and `r ncol(exp.data)` columns (or variables). The first two columns have information about the observation (`r colnames(exp.data)[1:2]`), and the remaining columns have measurements for the expression of `r ncol(exp.data) - 2` genes.

We ultimately want a heatmap where the different subjects are shown along the x-axis, the genes are shown along the y-axis, and the shading of the cell reflects how much each gene is expressed within a subject. This latter value, the measure of gene expression, is really just a third dimension. However, instead of creating a 3-dimensional plot that can be difficult to visualize, we instead use shading for our "z-axis". To this end, we need our data formatted so we have a column corresponding to each of these three dimensions:

+ X: Subject ID
+ Y: Gene symbol
+ Z: Expression

The challenge is that our data are _not_ formatted like this. While the `subject` column corresponds to what we would like for our x-axis, we do not have columns that correspond to what is needed for the y- and z-axes. All the data are in our data frame, but we need to take a table that looks like this:

| `r colnames(exp.data)[1]` | `r colnames(exp.data)[2]` | `r colnames(exp.data)[3]` | `r colnames(exp.data)[4]` | `r colnames(exp.data)[5]` |
|:-------------------|:-------------------|:------------------------------|:------------------------------------|:------------------------------------|
| `r exp.data[1, 1]` | `r exp.data[1, 2]` |  `r round(exp.data[1, 3], 3)` | `r round(exp.data[1, 4], 3)` | `r round(exp.data[1, 5], 3)` |
| `r exp.data[2, 1]` | `r exp.data[2, 2]` |  `r round(exp.data[2, 3], 3)` | `r round(exp.data[2, 4], 3)` | `r round(exp.data[1, 5], 3)` |
| ...                | ...                | ...                           | ...                                 |                                     |

And transform it to one with a column for the gene and a column for expression, like this:

| subject             | gene                      | expression |
|:--------------------|:--------------------------|:----------|
|  `r exp.data[1, 1]` | `r colnames(exp.data)[3]` |  `r round(exp.data[1, 3], 3)` |
|  `r exp.data[1, 1]` | `r colnames(exp.data)[4]` |  `r round(exp.data[1, 4], 3)` |
|  `r exp.data[1, 1]` | `r colnames(exp.data)[5]` |  `r round(exp.data[1, 5], 3)` |
|  `r exp.data[2, 1]` | `r colnames(exp.data)[3]` |  `r round(exp.data[2, 3], 3)` |
|  `r exp.data[2, 1]` | `r colnames(exp.data)[4]` |  `r round(exp.data[2, 4], 3)` |
|  `r exp.data[2, 1]` | `r colnames(exp.data)[5]` |  `r round(exp.data[2, 5], 3)` |
| ...                 | ...            | ...       |

talk about structure of data
talk about what we **want** structure to be (in general)
show long format table
show wide format table
use tidyr's gather to transform data (without excluding columns)
show what went wrong
use gather again, ignoring subject & treatment
Show script again at this point

Transform data to long format
```{r}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")

exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)

exp.long <- gather(data = exp.data, 
                   key = gene, 
                   value = expression, 
                   -subject, -treatment)
```

Look at the top of the long data:
```{r}
head(exp.long)
```




***

## Visualize the data!

For this plot, we are going to first create the heatmap object with the `ggplot` function, then print the plot. We create the object by assigning the output of the `ggplot` call to the variable `exp.heatmap`, then entering the name of this object to print it to the screen.

```{r}
exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = expression))
exp.heatmap
```

_What happened?_ Our plot doesn't show any data!? Here is where functionality of ggplot is evident. The way it works is by effectively drawing layer upon layer of graphics. So we have established the plot, we told R what to put on the X and Y axes, but we need to add one more bit of information to tell ggplot _how_ to display data in the plot area. For a heat map, we use `geom_tile()`, literally adding this to the ggplot object with a plus sign (+):

```{r}
exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = expression)) +
  geom_tile()

exp.heatmap
```

Do log transformation and graph that instead
```{r}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")

exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)

exp.long <- gather(data = exp.data, 
                   key = gene, 
                   value = expression, 
                   -subject, -treatment)

exp.long$log.expression <- log(exp.long$expression)

exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = log.expression)) +
  geom_tile()

exp.heatmap
```

Clean up x-axis
```{r}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")

exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)

exp.long <- gather(data = exp.data, 
                   key = gene, 
                   value = expression, 
                   -subject, -treatment)

exp.long$log.expression <- log(exp.long$expression)

exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = log.expression)) +
  geom_tile() +
  xlab(label = "Subject") +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5))

exp.heatmap
```

Add facet to separate control from flu
Final (without saving)
```{r}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")

exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)

exp.long <- gather(data = exp.data, 
                   key = gene, 
                   value = expression, 
                   -subject, -treatment)

exp.long$log.expression <- log(exp.long$expression)

exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = log.expression)) +
  geom_tile() +
  xlab(label = "Subject") +
  facet_grid(~ treatment, switch = "x", scales = "free_x", space = "free_x") +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5))

exp.heatmap

```


Final script:
```{r eval = FALSE}
# Gene expression heatmap
# Jeff Oliver
# jcoliver@email.arizona.edu
# 2017-09-14

library("tidyr")
library("ggplot2")

exp.data <- read.csv(file = "data/GSE68849-expression.csv", stringsAsFactors = FALSE)

exp.long <- gather(data = exp.data, 
                   key = gene, 
                   value = expression, 
                   -subject, -treatment)

exp.long$log.expression <- log(exp.long$expression)

exp.heatmap <- ggplot(data = exp.long, mapping = aes(x = subject,
                                                     y = gene,
                                                     fill = log.expression)) +
  geom_tile() +
  xlab(label = "Subject") +
  facet_grid(~ treatment, switch = "x", scales = "free_x", space = "free_x") +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5))

ggsave(filename = "output/expression-heatmap.pdf", plot = exp.heatmap)
```

***

## Additional resources

+ [resource one](url-one)
+ [resource two](url-two)
+ A [PDF version](https://jcoliver.github.io/learn-r/009-expression-heatmaps.pdf) of this lesson
+ The entire data set from NCBI is available at: [https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE68849](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE68849)

***

<a href="index.html">Back to learn-r main page</a>
  
Questions?  e-mail me at <a href="mailto:jcoliver@email.arizona.edu">jcoliver@email.arizona.edu</a>.